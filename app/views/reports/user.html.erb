<% expected_days = Holiday.expected_days_between(@user_report.day,@user_report.at_end_of_month) -%>
<% expected_hours = Holiday.expected_hours_between(@user_report.day,@user_report.at_end_of_month) -%>

<h1>User Report</h1>

<%= render :partial => 'sub_menu' -%>

<p class="error"><%= flash[:error] %></p>
<p class="notice"><%= flash[:notice] %></p>

<% form_tag 'user', :method => 'get', :id => "user_form" do %>
  <div>
    <table>
      <tr>
        <td><%= select_tag "month", options_from_collection_for_select( @user_report.months, 'first', 'last', params[:month] ? params[:month].to_i : @user_report.month  ) %></td>
        <td><%= select_tag "year", options_for_select(@user_report.years, params[:year].to_i) %></td>
      <td><%= submit_tag "View" %></td>
    </table>
  </div>
<% end -%>
<br/>

  <table class="regular" style="text-align:right">
    <tr>
      <th></th>
      <% @user_report.weeks.each do |date| %>
      <th>Week <%= date[0].cweek %> </th>
      <% end %>
    </tr>

    <tr class="grayed">
      <td class="underline overline" style="text-align:left">Normal working hours</td>
      <% @user_report.  expected.each do |hours| %>
      <td class="underline overline"><%= hours %> </td>
      <% end %>
    </tr>

    <tr><td colspan="99"></td></tr>

    <% @user_report.users.each do |user| %>
      <tr>
        <td style="text-align:left"><span class="<%= user.status_for_month(@user_report.day, expected_days, expected_hours)%>">
          <%= link_to h(user.name), user_month_review_path( user, {:id => :calendar}.merge( date_to_url(@user_report.day) ) ) %>
        </span></td>
        <% @user_report.weeks.each_with_index do |range, index| %>
          <% hours = TimeEntry.for_user(user).between(range[0], range[1]).sum(:hours) %>
          <% color_code = case hours
              when 0 : "grayed"
              when 0..(@user_report.expected[index] -1): "red"
              when (@user_report.expected[index] - 1)..(@user_report.expected[index] * 1.3): "black"
              else "high"
          end %>

            <td class="<%= color_code -%>"><%= hours %></td>

        <% end %>
      </tr>
    <% end %>

    <tr>
      <th class="overline">Total</th>
      <% @user_report.totals.each do |total| %>
      <th class="overline"><%= total %></th>
      <% end %>
    </tr>
    
  </table>

  <%= will_paginate @user_report.users %>
  <br/>

<%#= render :partial => 'download', :locals => { :params => params, :action => 'user' } -%>


